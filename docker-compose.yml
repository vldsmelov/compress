services:
  contract_extractor:
    build: ./services/contract_extractor
    container_name: contract_extractor
    environment:
      - MODEL=${MODEL:-qwen3:14b}
      - TEMPERATURE=${TEMPERATURE:-0.1}
      - MAX_TOKENS=${MAX_TOKENS:-1024}
      # - OLLAMA_HOST=http://ollama_ext:11434
      - OLLAMA_HOST=http://192.168.3.63:11434
      - NUMERIC_TOLERANCE=${NUMERIC_TOLERANCE:-0.01}
      - USE_LLM=${USE_LLM:-true}
      - API_PORT=${API_PORT:-8085}
    command: uvicorn app.main:app --host 0.0.0.0 --port 8085 --reload --log-level info
    ports:
      - "${API_PORT:-8085}:8085"
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://127.0.0.1:8085/healthz >/dev/null || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 20
    restart: unless-stopped
    # depends_on:
    #   - ollama_ext
    networks:
      - app-network
  ai_econom:
    build: ./services/ai_econom
    container_name: ai_econom
    environment:
      # - OLLAMA_HOST=ollama_ext
      - OLLAMA_HOST=192.168.3.63
      - OLLAMA_PORT=11434
      - OLLAMA_MODEL=${AI_ECON_OLLAMA_MODEL:-qwen2.5vl:32b}
    ports:
      - "10000:10000"
    volumes:
      - ./services/ai_econom/data:/app/data
    restart: unless-stopped
    # depends_on:
    #   - ollama_ext
    networks:
      - app-network
  ai_legal:
    build: ./services/ai_legal
    container_name: ai_legal
    environment:
      # - OLLAMA_BASE_URL=http://ollama_ext:11434
      - OLLAMA_BASE_URL=http://192.168.3.63:11434
      - OLLAMA_MODEL=${AI_LEGAL_MODEL:-qwen3:14b}
    ports:
      - "8092:8000"
    restart: unless-stopped
    # depends_on:
    #   - ollama_ext
    networks:
      - app-network

  document_slicer:
    build: ./services/document_slicer
    container_name: document_slicer
    environment:
      - AI_ECONOM_SERVICE_URL=http://ai_econom:10000/analyze
      - AI_LEGAL_SERVICE_URL=http://ai_legal:8000/api/sections/full
      - CONTRACT_EXTRACTOR_URL=http://contract_extractor:8085/qa/docx?plan=default
      - SERVICE_HTTP_TIMEOUT=${SERVICE_HTTP_TIMEOUT:-120}
    ports:
      - "8090:8000"
    volumes:
      - document_data:/data
    restart: unless-stopped
    depends_on:
      - ai_econom
      - ai_legal
      - contract_extractor
    networks:
      - app-network
  admin-panel:
    build:
      context: ./services/admin-panel
      args:
        VITE_SLICER_API_BASE_URL: http://localhost:8090
        VITE_AI_LEGAL_API_BASE_URL: http://localhost:8092
    container_name: admin-panel
    environment:
      - VITE_SLICER_API_BASE_URL=http://localhost:8090
      - VITE_AI_LEGAL_API_BASE_URL=http://localhost:8092
    ports:
      - "8091:80"
    restart: unless-stopped
    networks:
      - app-network
  # ollama_ext:
  #   image: ollama/ollama:latest
  #   container_name: ollama_ext
  #   ports:
  #     - "11434:11434"
  #   volumes:
  #      - ollama_data:/root/.ollama
  #   restart: unless-stopped
  #   networks:
  #     - app-network

volumes:
  document_data:
  # ollama_data:

networks:
  app-network:
    driver: bridge